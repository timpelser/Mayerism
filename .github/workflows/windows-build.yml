name: Windows VST3 + Installer

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  BUILD_DIR: build
  TARGET: Mayerism

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2️⃣ Install CMake
      - name: Install CMake
        uses: lukka/get-cmake@latest

      # 3️⃣ Configure + Build
      - name: Configure CMake (Release)
        run: cmake -S . -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=Release

      - name: Build All
        run: cmake --build ${{ env.BUILD_DIR }} --config Release

      # 4️⃣ Prepare VST3 bundle output
      - name: Prepare VST3 bundle
        shell: powershell
        run: |
          $out = "output"
          if (Test-Path $out) { Remove-Item $out -Recurse -Force }
          New-Item -ItemType Directory -Path $out
          $vst3 = "${{ env.BUILD_DIR }}\Mayerism_artefacts\Release\VST3\${{ env.TARGET }}.vst3"
          if (-not (Test-Path $vst3)) {
            Write-Error "VST3 bundle not found: $vst3"
            exit 1
          }
          Copy-Item $vst3 "$out\${{ env.TARGET }}.vst3" -Recurse

      # 6️⃣ Compile installer with Inno Setup Action
      - name: Build Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          # path to your installer script
          path: "installer.iss"
          # optional flags (e.g. /O+ to force output)
          options: "/O+ /Oinstaller_output"

      # 7️⃣ Upload artifacts
      - name: Upload VST3 zip (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-Windows-VST3
          path: output

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-Windows-Installer
          path: "installer_output/*.exe"
