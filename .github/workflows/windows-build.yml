name: Windows VST3 + Installer

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  BUILD_DIR: build
  TARGET: Mayerism

jobs:
  windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install CMake
        uses: lukka/get-cmake@v4

      - name: Configure
        run: cmake -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=Release

      - name: Build VST3
        run: cmake --build ${{ env.BUILD_DIR }} --config Release --target ${{ env.TARGET }}

      - name: Prepare VST3 bundle
        shell: powershell
        run: |
          $out = "output"
          if (Test-Path $out) { Remove-Item $out -Recurse -Force }
          New-Item -ItemType Directory -Path $out

          $vst3 = "${{ env.BUILD_DIR }}\Release\${{ env.TARGET }}.vst3"
          if (-not (Test-Path $vst3)) {
            Write-Error "VST3 bundle not found: $vst3"
            exit 1
          }

          Copy-Item $vst3 "$out\${{ env.TARGET }}.vst3" -Recurse

      - name: Zip VST3 (Windows)
        shell: powershell
        run: |
          Compress-Archive `
            -Path "output\${{ env.TARGET }}.vst3" `
            -DestinationPath "${{ env.TARGET }}-windows.vst3.zip"

      - name: Install Inno Setup
        uses: crazy-max/ghaction-inno-setup@v3

      - name: Build Installer
        run: iscc installer.iss

      - name: Upload VST3 zip (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-Windows-VST3
          path: Mayerism-windows.vst3.zip

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-Windows-Installer
          path: Mayerism-Installer*.exe
