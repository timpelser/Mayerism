name: macOS VST3 + Installer (Universal)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  BUILD_DIR: build
  TARGET: Mayerism

jobs:
  build-macos-universal:
    runs-on: macos-14

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2Ô∏è‚É£ Install CMake
      - name: Install CMake
        uses: lukka/get-cmake@latest

      # 3Ô∏è‚É£ Configure + Build
      - name: Configure CMake (Release, Universal)
        run: cmake -S . -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" -DCMAKE_OSX_SYSROOT=$(xcrun --show-sdk-path)

      - name: Build All
        run: cmake --build ${{ env.BUILD_DIR }} --config Release

      # 5Ô∏è‚É£ Import Signing Certificates (App + Installer)
      - name: Import Signing Certificates
        env:
          # Application Cert (for code signing)
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          # Installer Cert (for pkg signing) - NEW
          INSTALLER_CERT_BASE64: ${{ secrets.INSTALLER_CERT_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          # Paths
          CERT_APP_PATH=$RUNNER_TEMP/build_certificate_app.p12
          CERT_INST_PATH=$RUNNER_TEMP/build_certificate_installer.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode both certs
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERT_APP_PATH
          echo -n "$INSTALLER_CERT_BASE64" | base64 --decode -o $CERT_INST_PATH

          # Create/Unlock Keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import Application Cert
          security import $CERT_APP_PATH -k $KEYCHAIN_PATH -P "$P12_PASSWORD" -T /usr/bin/codesign
          
          # Import Installer Cert
          security import $CERT_INST_PATH -k $KEYCHAIN_PATH -P "$P12_PASSWORD" -T /usr/bin/productbuild -T /usr/bin/pkgbuild

          # Set permissions
          security set-key-partition-list -S apple-tool:,apple:,codesign:,productbuild:,pkgbuild: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychains -d user -s $KEYCHAIN_PATH

      # 6Ô∏è‚É£ Code Sign Components (VST3 and AU)
      - name: Code Sign Components
        run: |
          # Sign all built targets found in Release
          # Note: We sign the SOURCE files in BUILD_DIR before packaging
          # We check for both VST3 and Component (AU)
          
          IDENTITY="Developer ID Application"
          
          # VST3
          vst3_src="${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/VST3/${{ env.TARGET }}.vst3"
          if [ -d "$vst3_src" ]; then
             echo "Signing VST3..."
             codesign --force --deep --options runtime --timestamp --sign "$IDENTITY" "$vst3_src"
          else
             echo "‚ö†Ô∏è Warning: VST3 not found at $vst3_src"
          fi

          # AU (Component)
          au_src="${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/AU/${{ env.TARGET }}.component"
          if [ -d "$au_src" ]; then
             echo "Signing AU..."
             codesign --force --deep --options runtime --timestamp --sign "$IDENTITY" "$au_src"
          else
             echo "‚ö†Ô∏è Warning: AU not found at $au_src - Did you build it?"
             # Fail if AU missing, since we expect it now
             exit 1 
          fi

      # 7Ô∏è‚É£ Inspect & Verify Signatures
      - name: Verify Signatures
        run: |
          echo "Verifying VST3 Signature..."
          codesign -dv --verbose=4 "${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/VST3/${{ env.TARGET }}.vst3"
          
          echo "Verifying AU Signature..."
          codesign -dv --verbose=4 "${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/AU/${{ env.TARGET }}.component"

      # 8Ô∏è‚É£ Build Signed Intermediate Component Packages (Staging Approach)
      - name: Build Component Packages
        run: |
          mkdir -p packages
          INST_IDENTITY="Developer ID Installer"
          
          # 8.1 VST3 Staging
          mkdir -p staging_vst3/Library/Audio/Plug-Ins/VST3
          cp -R "${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/VST3/${{ env.TARGET }}.vst3" staging_vst3/Library/Audio/Plug-Ins/VST3/
          echo "VST3 Staging Size:"
          du -sh staging_vst3
          
          pkgbuild --root staging_vst3 \
                   --identifier "com.craftlabs.mayerism.vst3" \
                   --version "0.0.1" \
                   --sign "$INST_IDENTITY" \
                   "packages/Mayerism-VST3.pkg"

          # 8.2 AU Staging
          mkdir -p staging_au/Library/Audio/Plug-Ins/Components
          cp -R "${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/AU/${{ env.TARGET }}.component" staging_au/Library/Audio/Plug-Ins/Components/
          echo "AU Staging Size:"
          du -sh staging_au
          
          pkgbuild --root staging_au \
                   --identifier "com.craftlabs.mayerism.au" \
                   --version "0.0.1" \
                   --sign "$INST_IDENTITY" \
                   "packages/Mayerism-AU.pkg"
          
          echo "Intermediate Packages Size:"
          du -sh packages/*

      # 9Ô∏è‚É£ Build Final Product Installer
      - name: Build Product Installer
        run: |
          INST_IDENTITY="Developer ID Installer"
          FINAL_PKG="${{ env.TARGET }}-macOS-Universal-Installer.pkg"
          
          productbuild --distribution "Assets/Installer/distribution.xml" \
                       --package-path "packages" \
                       --resources "Assets/Installer" \
                       --sign "$INST_IDENTITY" \
                       --timestamp \
                       "$FINAL_PKG"
          
          echo "Final Installer Size:"
          du -sh "$FINAL_PKG"

      # üîü Verify PKG locally
      - name: Verify PKG
        run: |
          pkgutil --check-signature "${{ env.TARGET }}-macOS-Universal-Installer.pkg"
          # List files to verify structure
          pkgutil --payload-files "${{ env.TARGET }}-macOS-Universal-Installer.pkg"

      # 1Ô∏è‚É£1Ô∏è‚É£ Notarize Installer
      - name: Notarize Installer
        run: |
          xcrun notarytool submit "${{ env.TARGET }}-macOS-Universal-Installer.pkg" \
            --apple-id "${{ secrets.AC_USERNAME }}" \
            --password "${{ secrets.AC_PASSWORD }}" \
            --team-id "${{ secrets.AC_TEAM_ID }}" \
            --wait

      # 1Ô∏è‚É£2Ô∏è‚É£ Staple Ticket
      - name: Staple Ticket
        run: |
          xcrun stapler staple "${{ env.TARGET }}-macOS-Universal-Installer.pkg"

      # 1Ô∏è‚É£3Ô∏è‚É£ Upload Artifacts (Always)
      - name: Upload Installer
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-macOS-Universal-Installer
          path: Mayerism-macOS-Universal-Installer.pkg
