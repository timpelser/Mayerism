name: macOS VST3 + Installer (Universal)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  BUILD_DIR: build
  TARGET: Mayerism

jobs:
  build-macos-universal:
    runs-on: macos-14

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2Ô∏è‚É£ Install CMake
      - name: Install CMake
        uses: lukka/get-cmake@latest

      # 3Ô∏è‚É£ Configure + Build
      - name: Configure CMake (Release, Universal)
        run: cmake -S . -B ${{ env.BUILD_DIR }} -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"

      - name: Build All
        run: cmake --build ${{ env.BUILD_DIR }} --config Release

      # 4Ô∏è‚É£ Prepare VST3 bundle output
      - name: Prepare VST3 bundle
        run: |
          out="output"
          rm -rf "$out"
          mkdir -p "$out"
          vst3="${{ env.BUILD_DIR }}/Mayerism_artefacts/Release/VST3/${{ env.TARGET }}.vst3"
          if [ ! -d "$vst3" ]; then
            echo "Error: VST3 bundle not found: $vst3"
            exit 1
          fi
          cp -R "$vst3" "$out/${{ env.TARGET }}.vst3"
      # 5Ô∏è‚É£ Import Signing Certificate
      - name: Import Signing Certificate
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.P12_PASSWORD }} # Use same pass for temp keychain
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Import certificate and provision profile from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -k $KEYCHAIN_PATH -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Force use of this keychain for signing
          security list-keychains -d user -s $KEYCHAIN_PATH

      # 6Ô∏è‚É£ Sign VST3 Bundle (Hardened Runtime)
      - name: Sign VST3 Bundle
        env: 
          # Extract identity name from certificate subject 
          # OR just rely on 'Developer ID Application' auto-match via standard string
          # But better to use strict variable if needed. For now "Developer ID Application" is standard.
          SIGNING_IDENTITY: "Developer ID Application" 
        run: |
          # The -f (force) -s (sign) --deep (recursive) --options runtime (Hardened Runtime) --timestamp (Required for notarization)
          codesign --force --deep --options runtime --timestamp --sign "$SIGNING_IDENTITY" "output/${{ env.TARGET }}.vst3"

      # 7Ô∏è‚É£ Create DMG installer (Professional)
      - name: Create DMG installer
        run: |
          # Install create-dmg utility
          brew install create-dmg

          final_dmg="${{ env.TARGET }}-macOS-Universal-Installer.dmg"
          
          # Clean up previous attempts
          rm -f "$final_dmg"

          # Use create-dmg to build the installer
          # --volname: Name of the mounted volume
          # --background: Path to your BG image
          # --window-pos: Position on screen when opened
          # --window-size: Size of the window (should match BG image size)
          # --icon-size: Size of icons
          # --icon: Position of the plugin file (Name, X, Y)
          # --app-drop-link: Position of the VST3 folder drop target (X, Y) relative to the target path
          # output/Mayerism.vst3: The source file to put in the DMG
          
          # Prepare the custom symlink for the installer
          ln -s /Library/Audio/Plug-Ins/VST3 output/VST3

          create-dmg \
            --volname "Mayerism" \
            --background "Assets/DMG Background.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.TARGET }}.vst3" 131 197 \
            --icon "VST3" 468 197 \
            --hide-extension "VST3" \
            "$final_dmg" \
            "output/"

      # 8Ô∏è‚É£ Sign the DMG itself
      - name: Sign DMG
        run: |
           codesign --force --sign "Developer ID Application" --timestamp "${{ env.TARGET }}-macOS-Universal-Installer.dmg"

      # 9Ô∏è‚É£ Notarize DMG
      - name: Notarize DMG
        run: |
          xcrun notarytool submit "${{ env.TARGET }}-macOS-Universal-Installer.dmg" \
            --apple-id "${{ secrets.AC_USERNAME }}" \
            --password "${{ secrets.AC_PASSWORD }}" \
            --team-id "${{ secrets.AC_TEAM_ID }}" \
            --wait

      # üîü Staple Ticket
      - name: Staple Ticket
        run: |
          xcrun stapler staple "${{ env.TARGET }}-macOS-Universal-Installer.dmg"

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload artifacts
      - name: Upload VST3 zip (macOS Universal)
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-macOS-Universal-VST3
          path: output

      - name: Upload DMG Installer
        uses: actions/upload-artifact@v4
        with:
          name: Mayerism-macOS-Universal-Installer
          path: Mayerism-macOS-Universal-Installer.dmg
